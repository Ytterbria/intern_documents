*消息堆积的原因
1.消费者消费能力不足. 生产者速度远远大于消费者的处理速度,导致堆积
2.消费者宕机/链接断开, 导致队列消息无人消费,消息不断堆积
3.消息未ACK,rabbitMQ要等待消费者ack过后才把消息删除,如果始终没有收到ack
消息一直不被删除清理,也会导致积压
4.消息过大,导致热舞内存占满,转存到了磁盘,处理的速度降低,导致积压

*消息积压的表现: 
.队列消息数量持续增加 rabbitmqctl list_queues 可以看到messages_ready很大
.内存磁盘压力升高, rabbitMQ会出发流控 flow control,暂停生产者写入
.消费延迟明显增加,新消息很难及时投递给消费者

*rabbit自带处理机制
.内存不足的时候写入磁盘, rabbitMQ会在内存不足的时候,把消息写到磁盘中,防止OOM
.流控机制,flow control, 当磁盘/内存达到阈值,rabbit会阻塞生产之,缓减堆积
.死信队列: 过期或无法投递的消息会进入死信队列,避免主队列继续膨胀

*开发者如何解决
1.增加消费者能力: 横向扩展,增加消费者实力,分担消费压力,
纵向使用多线程/批量消费,单个消费者开多线程,提高消费吞吐
2.限制生产速度,在生产端添加RateLimit限流, 或者使用flow control组件防止无限制写入
3.消息过期/丢弃,给消息设置TTL,过期则自动丢弃或者进入死信队列
4.换用更合理的队列模型, 例如优先级队列处理优先级较高的消息,避免重要消息被淹没,
延迟队列 + 死信队列,让过期的消息自动转移



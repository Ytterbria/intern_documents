为什么会发生重复消费 ?
1.消费者收到消息过后崩溃 -> rabbitMQ认为消息没被确认 -> 重新投递
2.网络异常导致消息没用成功到rabbitMQ -> exchange认为消息未被消费 -> 重发
3.死信队列和手动重试也可能导致重复消费
RabbitMQ本身不能完全保证消息纸杯消费一次,通常它确保的是at-least-once,
而不是at-most-once

如何防止重复消费
1.幂等消费
核心思想: 消费者处理同一条消息多次,结果与处理结果一次一致
实现方式: 给每条消息带上一个uuid或业务id,然后缓存记录
(processedId),如果processedId.contains(messageId),那么久跳过
这其中的数据库操作,消费记录的标记要进行原子性完成(使用事务 + 乐观锁)
2.消费者ACK控制
使用手动ack而不是自动ack,消费失败之后 -> NACK -> rabbitMQ可以重复投递
这样可以避免消息丢失保证可靠性,但是如果消费者处理完成了,但是ACK没发送,就可能导致消息重复消费
3.消息去重组件/缓存
在高并发场景,可以在Redis中进行短期去重 key =ID,value = 已消费标记+ TTL
